#cloud-config
package_update: true
package_upgrade: true

write_files:
  - path: /opt/openclaw/setup.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -euo pipefail
      exec > /var/log/openclaw-setup.log 2>&1
      echo "=== OpenClaw setup started at $(date) ==="

      ADMIN_USER="{0}"
      OPENCLAW_PORT="{1}"
      KV_NAME="{2}"
      HOME_DIR="/home/$ADMIN_USER"

      # Install Node.js 22 via NodeSource
      echo "Installing Node.js 22..."
      curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      apt-get install -y nodejs

      # Install pnpm globally
      echo "Installing pnpm..."
      npm install -g pnpm

      # Install Azure CLI
      echo "Installing Azure CLI..."
      curl -sL https://aka.ms/InstallAzureCLIDeb | bash

      # Install Claude Code CLI
      echo "Installing Claude Code CLI..."
      npm install -g @anthropic-ai/claude-code

      # Authenticate with managed identity
      echo "Authenticating with managed identity..."
      az login --identity

      # Wait for Key Vault RBAC propagation (can take 1-5 min)
      echo "Waiting for Key Vault access..."
      MAX_RETRIES=30
      RETRY_INTERVAL=10
      for i in $(seq 1 $MAX_RETRIES); do
        if az keyvault secret show --vault-name "$KV_NAME" --name "openclaw-secrets" > /dev/null 2>&1; then
          echo "Key Vault access confirmed on attempt $i"
          break
        fi
        if [ "$i" -eq "$MAX_RETRIES" ]; then
          echo "ERROR: Could not access Key Vault after $MAX_RETRIES attempts"
          exit 1
        fi
        echo "Attempt $i/$MAX_RETRIES - waiting $RETRY_INTERVAL seconds..."
        sleep $RETRY_INTERVAL
      done

      # Pull secrets from Key Vault
      echo "Pulling secrets from Key Vault..."
      mkdir -p "$HOME_DIR/.openclaw/credentials"
      az keyvault secret show --vault-name "$KV_NAME" --name "openclaw-secrets" --query "value" -o tsv > "$HOME_DIR/.openclaw/credentials/secrets.json"

      # Install OpenClaw
      echo "Installing OpenClaw..."
      npm install -g openclaw@latest

      # Write OpenClaw config
      echo "Writing OpenClaw config..."
      cat > "$HOME_DIR/.openclaw/openclaw.json" << 'OCEOF'
      {{
        "gateway": {{
          "bind": "0.0.0.0:{1}"
        }},
        "model": {{
          "provider": "anthropic",
          "name": "claude-sonnet-4-20250514"
        }},
        "channels": []
      }}
      OCEOF

      # Fix ownership
      chown -R "$ADMIN_USER:$ADMIN_USER" "$HOME_DIR/.openclaw"

      # Create systemd user service
      echo "Creating systemd service..."
      SYSTEMD_DIR="$HOME_DIR/.config/systemd/user"
      mkdir -p "$SYSTEMD_DIR"
      cat > "$SYSTEMD_DIR/openclaw-gateway.service" << 'SVCEOF'
      [Unit]
      Description=OpenClaw Gateway
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      ExecStart=/usr/bin/openclaw gateway run
      Restart=always
      RestartSec=5
      Environment=NODE_ENV=production

      [Install]
      WantedBy=default.target
      SVCEOF

      chown -R "$ADMIN_USER:$ADMIN_USER" "$HOME_DIR/.config"

      # Enable linger for user service to start at boot
      loginctl enable-linger "$ADMIN_USER"

      # Enable and start the service as the admin user
      sudo -u "$ADMIN_USER" XDG_RUNTIME_DIR="/run/user/$(id -u $ADMIN_USER)" systemctl --user daemon-reload
      sudo -u "$ADMIN_USER" XDG_RUNTIME_DIR="/run/user/$(id -u $ADMIN_USER)" systemctl --user enable openclaw-gateway
      sudo -u "$ADMIN_USER" XDG_RUNTIME_DIR="/run/user/$(id -u $ADMIN_USER)" systemctl --user start openclaw-gateway

      echo "=== OpenClaw setup completed at $(date) ==="

runcmd:
  - bash /opt/openclaw/setup.sh
