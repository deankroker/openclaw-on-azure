{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "9216077854761013332"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "metadata": {
        "description": "Environment name (used for resource naming and tagging)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region"
      }
    },
    "instanceCount": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Number of VMSS instances"
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_B2s",
      "metadata": {
        "description": "VM size"
      }
    },
    "sshPublicKey": {
      "type": "string",
      "metadata": {
        "description": "SSH public key for VM access"
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "openclaw",
      "metadata": {
        "description": "Admin username for VMs"
      }
    },
    "openclawPort": {
      "type": "int",
      "defaultValue": 18789,
      "metadata": {
        "description": "OpenClaw gateway port"
      }
    },
    "openclawSecrets": {
      "type": "securestring",
      "metadata": {
        "description": "OpenClaw secrets as JSON string"
      }
    },
    "sshSourceCidr": {
      "type": "string",
      "defaultValue": "*",
      "metadata": {
        "description": "Source address CIDR for SSH access"
      }
    },
    "gatewaySourceCidr": {
      "type": "string",
      "defaultValue": "*",
      "metadata": {
        "description": "Source address CIDR for OpenClaw gateway access"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "project": "openclaw",
        "environment": "[parameters('environment')]"
      },
      "metadata": {
        "description": "Resource tags"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "network",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "openclawPort": {
            "value": "[parameters('openclawPort')]"
          },
          "sshSourceCidr": {
            "value": "[parameters('sshSourceCidr')]"
          },
          "gatewaySourceCidr": {
            "value": "[parameters('gatewaySourceCidr')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "1702110204281210383"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region"
              }
            },
            "sshSourceCidr": {
              "type": "string",
              "defaultValue": "*",
              "metadata": {
                "description": "Source address CIDR for SSH access"
              }
            },
            "gatewaySourceCidr": {
              "type": "string",
              "defaultValue": "*",
              "metadata": {
                "description": "Source address CIDR for OpenClaw gateway access"
              }
            },
            "openclawPort": {
              "type": "int",
              "defaultValue": 18789,
              "metadata": {
                "description": "OpenClaw gateway port"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "namePrefix": "[format('openclaw-{0}', parameters('environment'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}-nsg', variables('namePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowSSH",
                    "properties": {
                      "priority": 1000,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "[parameters('sshSourceCidr')]",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "22"
                    }
                  },
                  {
                    "name": "AllowOpenClawGateway",
                    "properties": {
                      "priority": 1100,
                      "direction": "Inbound",
                      "access": "Allow",
                      "protocol": "Tcp",
                      "sourceAddressPrefix": "[parameters('gatewaySourceCidr')]",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "[string(parameters('openclawPort'))]"
                    }
                  },
                  {
                    "name": "DenyAllInbound",
                    "properties": {
                      "priority": 4096,
                      "direction": "Inbound",
                      "access": "Deny",
                      "protocol": "*",
                      "sourceAddressPrefix": "*",
                      "sourcePortRange": "*",
                      "destinationAddressPrefix": "*",
                      "destinationPortRange": "*"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}-vnet', variables('namePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "10.0.0.0/16"
                  ]
                },
                "subnets": [
                  {
                    "name": "vmss-subnet",
                    "properties": {
                      "addressPrefix": "10.0.1.0/24",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', variables('namePrefix')))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('{0}-nsg', variables('namePrefix')))]"
              ]
            }
          ],
          "outputs": {
            "subnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}-vnet', variables('namePrefix'))), '2024-05-01').subnets[0].id]"
            },
            "vnetName": {
              "type": "string",
              "value": "[format('{0}-vnet', variables('namePrefix'))]"
            },
            "nsgName": {
              "type": "string",
              "value": "[format('{0}-nsg', variables('namePrefix'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyvault",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "openclawSecrets": {
            "value": "[parameters('openclawSecrets')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "8762153833806252911"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region"
              }
            },
            "openclawSecrets": {
              "type": "securestring",
              "metadata": {
                "description": "OpenClaw secrets as JSON string"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "namePrefix": "[format('openclaw-{0}', parameters('environment'))]",
            "kvName": "[format('{0}-kv-{1}', variables('namePrefix'), uniqueString(resourceGroup().id))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2024-11-01",
              "name": "[variables('kvName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2024-11-01",
              "name": "[format('{0}/{1}', variables('kvName'), 'openclaw-secrets')]",
              "properties": {
                "value": "[parameters('openclawSecrets')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', variables('kvName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "value": "[variables('kvName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('kvName')), '2024-11-01').vaultUri]"
            },
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('kvName'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "vmss",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environment": {
            "value": "[parameters('environment')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "instanceCount": {
            "value": "[parameters('instanceCount')]"
          },
          "vmSize": {
            "value": "[parameters('vmSize')]"
          },
          "sshPublicKey": {
            "value": "[parameters('sshPublicKey')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "openclawPort": {
            "value": "[parameters('openclawPort')]"
          },
          "subnetId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network'), '2025-04-01').outputs.subnetId.value]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault'), '2025-04-01').outputs.keyVaultName.value]"
          },
          "keyVaultId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault'), '2025-04-01').outputs.keyVaultId.value]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "14813499300409213172"
            }
          },
          "parameters": {
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment name"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Azure region"
              }
            },
            "instanceCount": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Number of VM instances"
              }
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_B2s",
              "metadata": {
                "description": "VM size"
              }
            },
            "sshPublicKey": {
              "type": "string",
              "metadata": {
                "description": "SSH public key"
              }
            },
            "adminUsername": {
              "type": "string",
              "defaultValue": "openclaw",
              "metadata": {
                "description": "Admin username"
              }
            },
            "openclawPort": {
              "type": "int",
              "defaultValue": 18789,
              "metadata": {
                "description": "OpenClaw gateway port"
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID for VMSS"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "namePrefix": "[format('openclaw-{0}', parameters('environment'))]",
            "cloudInitRaw": "#cloud-config\npackage_update: true\npackage_upgrade: true\n\nwrite_files:\n  - path: /opt/openclaw/setup.sh\n    permissions: \"0755\"\n    content: |\n      #!/bin/bash\n      set -euo pipefail\n      exec > /var/log/openclaw-setup.log 2>&1\n      echo \"=== OpenClaw setup started at $(date) ===\"\n\n      ADMIN_USER=\"{0}\"\n      OPENCLAW_PORT=\"{1}\"\n      KV_NAME=\"{2}\"\n      HOME_DIR=\"/home/$ADMIN_USER\"\n\n      # Install Node.js 22 via NodeSource\n      echo \"Installing Node.js 22...\"\n      curl -fsSL https://deb.nodesource.com/setup_22.x | bash -\n      apt-get install -y nodejs\n\n      # Install pnpm globally\n      echo \"Installing pnpm...\"\n      npm install -g pnpm\n\n      # Install Azure CLI\n      echo \"Installing Azure CLI...\"\n      curl -sL https://aka.ms/InstallAzureCLIDeb | bash\n\n      # Install Claude Code CLI\n      echo \"Installing Claude Code CLI...\"\n      npm install -g @anthropic-ai/claude-code\n\n      # Authenticate with managed identity\n      echo \"Authenticating with managed identity...\"\n      az login --identity\n\n      # Wait for Key Vault RBAC propagation (can take 1-5 min)\n      echo \"Waiting for Key Vault access...\"\n      MAX_RETRIES=30\n      RETRY_INTERVAL=10\n      for i in $(seq 1 $MAX_RETRIES); do\n        if az keyvault secret show --vault-name \"$KV_NAME\" --name \"openclaw-secrets\" > /dev/null 2>&1; then\n          echo \"Key Vault access confirmed on attempt $i\"\n          break\n        fi\n        if [ \"$i\" -eq \"$MAX_RETRIES\" ]; then\n          echo \"ERROR: Could not access Key Vault after $MAX_RETRIES attempts\"\n          exit 1\n        fi\n        echo \"Attempt $i/$MAX_RETRIES - waiting $RETRY_INTERVAL seconds...\"\n        sleep $RETRY_INTERVAL\n      done\n\n      # Pull secrets from Key Vault\n      echo \"Pulling secrets from Key Vault...\"\n      mkdir -p \"$HOME_DIR/.openclaw/credentials\"\n      az keyvault secret show --vault-name \"$KV_NAME\" --name \"openclaw-secrets\" --query \"value\" -o tsv > \"$HOME_DIR/.openclaw/credentials/secrets.json\"\n\n      # Install OpenClaw\n      echo \"Installing OpenClaw...\"\n      npm install -g openclaw@latest\n\n      # Write OpenClaw config\n      echo \"Writing OpenClaw config...\"\n      cat > \"$HOME_DIR/.openclaw/openclaw.json\" << 'OCEOF'\n      {{\n        \"gateway\": {{\n          \"bind\": \"0.0.0.0:{1}\"\n        }},\n        \"model\": {{\n          \"provider\": \"anthropic\",\n          \"name\": \"claude-sonnet-4-20250514\"\n        }},\n        \"channels\": []\n      }}\n      OCEOF\n\n      # Fix ownership\n      chown -R \"$ADMIN_USER:$ADMIN_USER\" \"$HOME_DIR/.openclaw\"\n\n      # Create systemd user service\n      echo \"Creating systemd service...\"\n      SYSTEMD_DIR=\"$HOME_DIR/.config/systemd/user\"\n      mkdir -p \"$SYSTEMD_DIR\"\n      cat > \"$SYSTEMD_DIR/openclaw-gateway.service\" << 'SVCEOF'\n      [Unit]\n      Description=OpenClaw Gateway\n      After=network-online.target\n      Wants=network-online.target\n\n      [Service]\n      Type=simple\n      ExecStart=/usr/bin/openclaw gateway run\n      Restart=always\n      RestartSec=5\n      Environment=NODE_ENV=production\n\n      [Install]\n      WantedBy=default.target\n      SVCEOF\n\n      chown -R \"$ADMIN_USER:$ADMIN_USER\" \"$HOME_DIR/.config\"\n\n      # Enable linger for user service to start at boot\n      loginctl enable-linger \"$ADMIN_USER\"\n\n      # Enable and start the service as the admin user\n      sudo -u \"$ADMIN_USER\" XDG_RUNTIME_DIR=\"/run/user/$(id -u $ADMIN_USER)\" systemctl --user daemon-reload\n      sudo -u \"$ADMIN_USER\" XDG_RUNTIME_DIR=\"/run/user/$(id -u $ADMIN_USER)\" systemctl --user enable openclaw-gateway\n      sudo -u \"$ADMIN_USER\" XDG_RUNTIME_DIR=\"/run/user/$(id -u $ADMIN_USER)\" systemctl --user start openclaw-gateway\n\n      echo \"=== OpenClaw setup completed at $(date) ===\"\n\nruncmd:\n  - bash /opt/openclaw/setup.sh\n",
            "cloudInitFormatted": "[format(variables('cloudInitRaw'), parameters('adminUsername'), string(parameters('openclawPort')), parameters('keyVaultName'))]",
            "keyVaultSecretsUserRole": "4633458b-17de-408a-b874-0445c86b69e6"
          },
          "resources": [
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets",
              "apiVersion": "2024-07-01",
              "name": "[format('{0}-vmss', variables('namePrefix'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "sku": {
                "name": "[parameters('vmSize')]",
                "capacity": "[parameters('instanceCount')]"
              },
              "properties": {
                "orchestrationMode": "Flexible",
                "platformFaultDomainCount": 1,
                "virtualMachineProfile": {
                  "osProfile": {
                    "computerNamePrefix": "openclaw",
                    "adminUsername": "[parameters('adminUsername')]",
                    "linuxConfiguration": {
                      "disablePasswordAuthentication": true,
                      "ssh": {
                        "publicKeys": [
                          {
                            "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                            "keyData": "[parameters('sshPublicKey')]"
                          }
                        ]
                      }
                    },
                    "customData": "[base64(variables('cloudInitFormatted'))]"
                  },
                  "storageProfile": {
                    "osDisk": {
                      "createOption": "FromImage",
                      "diskSizeGB": 30,
                      "managedDisk": {
                        "storageAccountType": "Standard_LRS"
                      }
                    },
                    "imageReference": {
                      "publisher": "Canonical",
                      "offer": "ubuntu-24_04-lts",
                      "sku": "server",
                      "version": "latest"
                    }
                  },
                  "securityProfile": {
                    "securityType": "TrustedLaunch",
                    "uefiSettings": {
                      "secureBootEnabled": true,
                      "vTpmEnabled": true
                    }
                  },
                  "networkProfile": {
                    "networkApiVersion": "2024-05-01",
                    "networkInterfaceConfigurations": [
                      {
                        "name": "[format('{0}-nic', variables('namePrefix'))]",
                        "properties": {
                          "primary": true,
                          "ipConfigurations": [
                            {
                              "name": "[format('{0}-ipconfig', variables('namePrefix'))]",
                              "properties": {
                                "subnet": {
                                  "id": "[parameters('subnetId')]"
                                },
                                "publicIPAddressConfiguration": {
                                  "name": "[format('{0}-pip', variables('namePrefix'))]",
                                  "properties": {
                                    "idleTimeoutInMinutes": 15
                                  }
                                }
                              }
                            }
                          ]
                        }
                      }
                    ]
                  }
                },
                "upgradePolicy": {
                  "mode": "Manual"
                }
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
              "name": "[guid(resourceId('Microsoft.Compute/virtualMachineScaleSets', format('{0}-vmss', variables('namePrefix'))), parameters('keyVaultId'), variables('keyVaultSecretsUserRole'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('keyVaultSecretsUserRole'))]",
                "principalId": "[reference(resourceId('Microsoft.Compute/virtualMachineScaleSets', format('{0}-vmss', variables('namePrefix'))), '2024-07-01', 'full').identity.principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets', format('{0}-vmss', variables('namePrefix')))]"
              ]
            }
          ],
          "outputs": {
            "vmssName": {
              "type": "string",
              "value": "[format('{0}-vmss', variables('namePrefix'))]"
            },
            "vmssId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', format('{0}-vmss', variables('namePrefix')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'keyvault')]",
        "[resourceId('Microsoft.Resources/deployments', 'network')]"
      ]
    }
  ],
  "outputs": {
    "vmssName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'vmss'), '2025-04-01').outputs.vmssName.value]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'keyvault'), '2025-04-01').outputs.keyVaultName.value]"
    },
    "vnetName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'network'), '2025-04-01').outputs.vnetName.value]"
    }
  }
}